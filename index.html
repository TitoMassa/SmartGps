<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Move Pro</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <style>
        /* Estilos CSS */
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }

        header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-align: center;
        }

        main {
            display: flex;
            flex: 1; /* Ocupa el espacio restante */
            overflow: hidden; /* Evita desbordamiento */
            padding: 10px;
            gap: 10px;
        }

        #controls {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto; /* Scroll si es necesario */
        }

        #map-container {
            flex: 1; /* Ocupa el espacio restante */
            display: flex;
            flex-direction: column;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #map {
            flex: 1;
             border-radius: 0 0 8px 8px;
        }


        #add-stop-form label,
        #route-info label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        #add-stop-form input[type="text"],
        #add-stop-form input[type="time"],
        #add-stop-form input[type="number"],
        #add-stop-form button,
        #startRouteBtn {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

         #add-stop-form input[readonly] {
            background-color: #eee;
            cursor: not-allowed;
         }

        #add-stop-form button,
        #startRouteBtn {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #add-stop-form button:hover,
        #startRouteBtn:hover {
            background-color: #0056b3;
        }

        #stops-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            max-height: 200px; /* Limita altura para scroll */
            overflow-y: auto;
            border-top: 1px solid #eee;
        }

        #stops-list li {
            padding: 8px 5px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
         #stops-list li span {
            flex-grow: 1;
            margin-right: 10px;
         }

        #stops-list button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
         #stops-list button:hover {
             background-color: #c82333;
         }


        #status-display {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-size: 1.8em;
            font-weight: bold;
        }

        #status-display.on-time {
            background-color: #d4edda; /* Verde claro */
            color: #155724; /* Verde oscuro */
            border: 1px solid #c3e6cb;
        }

        #status-display.late {
            background-color: #f8d7da; /* Rojo claro */
            color: #721c24; /* Rojo oscuro */
            border: 1px solid #f5c6cb;
        }

        #status-display.early {
            background-color: #cce5ff; /* Azul claro */
            color: #004085; /* Azul oscuro */
            border: 1px solid #b8daff;
        }

         #status-display.idle {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
            font-size: 1.2em;
         }

         .leaflet-popup-content button {
             margin-top: 10px;
             padding: 5px 10px;
             background-color: #28a745;
             color: white;
             border: none;
             border-radius: 4px;
             cursor: pointer;
         }
          .leaflet-popup-content button:hover {
               background-color: #218838;
           }

    </style>
</head>
<body>

    <header>
        <h1>Smart Move Pro</h1>
    </header>

    <main>
        <div id="controls">
            <h2>Controles de Ruta</h2>

            <div id="add-stop-form">
                <h3>Añadir Parada</h3>
                 <p style="font-size: 0.8em; color: #555;">Haz clic en el mapa para obtener coordenadas o ingrésalas manualmente.</p>
                <label for="stop-name">Nombre Parada:</label>
                <input type="text" id="stop-name" placeholder="Ej: Esq. Av. Corrientes">

                <label for="stop-time">Horario Programado (HH:MM):</label>
                <input type="time" id="stop-time">

                 <label for="stop-lat">Latitud:</label>
                <input type="number" id="stop-lat" step="any" placeholder="Obtenida del mapa">

                 <label for="stop-lng">Longitud:</label>
                <input type="number" id="stop-lng" step="any" placeholder="Obtenida del mapa">

                <button id="addStopBtn">Añadir Parada a la Ruta</button>
            </div>

            <div id="route-info">
                <h3>Ruta Actual</h3>
                 <label for="avg-speed">Velocidad Promedio (km/h):</label>
                 <input type="number" id="avg-speed" value="30" min="1">
                <ul id="stops-list">
                    <!-- Las paradas añadidas aparecerán aquí -->
                </ul>
                 <button id="startRouteBtn" disabled>Iniciar Seguimiento de Ruta</button>
            </div>

            <div id="status-section">
                <h3>Estado Actual</h3>
                <div id="status-display" class="idle">Esperando inicio de ruta...</div>
                 <p id="gps-status" style="font-size: 0.8em; text-align: center; color: #666;">GPS: Esperando señal...</p>
            </div>
        </div>

        <div id="map-container">
             <div style="padding: 10px; background-color: #eee; border-bottom: 1px solid #ccc; border-radius: 8px 8px 0 0;">
                <strong>Mapa</strong> (Haz clic para añadir parada)
             </div>
            <div id="map"></div>
        </div>
    </main>

    <script>
        // --- Variables Globales ---
        let map;
        let stops = []; // Array para almacenar las paradas { id, name, time, lat, lng }
        let currentLocationMarker = null;
        let stopMarkers = {}; // Objeto para guardar marcadores de parada { stopId: marker }
        let currentStopIndex = -1; // Índice de la próxima parada en el array `stops`
        let watchId = null; // ID del watcher de geolocalización
        let averageSpeedKMH = 30; // Velocidad promedio inicial
        let lastKnownPosition = null; // Guarda la última posición conocida
        const R = 6371; // Radio de la Tierra en km (para Haversine)

        // --- Elementos del DOM ---
        const stopNameInput = document.getElementById('stop-name');
        const stopTimeInput = document.getElementById('stop-time');
        const stopLatInput = document.getElementById('stop-lat');
        const stopLngInput = document.getElementById('stop-lng');
        const addStopBtn = document.getElementById('addStopBtn');
        const stopsList = document.getElementById('stops-list');
        const startRouteBtn = document.getElementById('startRouteBtn');
        const statusDisplay = document.getElementById('status-display');
        const avgSpeedInput = document.getElementById('avg-speed');
        const gpsStatus = document.getElementById('gps-status');

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            loadAverageSpeed(); // Cargar velocidad guardada si existe
            avgSpeedInput.addEventListener('change', () => {
                 averageSpeedKMH = parseFloat(avgSpeedInput.value) || 30;
                 // Podrías guardar esto en localStorage si quieres persistencia
                 // localStorage.setItem('smartMoveProAvgSpeed', averageSpeedKMH);
                 if(currentStopIndex !== -1 && lastKnownPosition) {
                     // Recalcular si la ruta está activa
                     handleLocationUpdate(lastKnownPosition);
                 }
            });
            addStopBtn.addEventListener('click', addStop);
            startRouteBtn.addEventListener('click', startRouteTracking);

            // Intenta obtener una ubicación inicial para centrar el mapa
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], 13);
                     updateGPSStatus(`Precisión: ${position.coords.accuracy.toFixed(0)}m`);
                },
                () => {
                    // Si falla, usa una ubicación por defecto (e.g., Buenos Aires)
                    map.setView([-34.6037, -58.3816], 12);
                    updateGPSStatus("No se pudo obtener ubicación inicial.");
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

        function initializeMap() {
            map = L.map('map').setView([-34.6037, -58.3816], 12); // Centro inicial (Bs As)

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Evento de clic en el mapa para añadir paradas
            map.on('click', (e) => {
                const { lat, lng } = e.latlng;
                stopLatInput.value = lat.toFixed(6);
                stopLngInput.value = lng.toFixed(6);

                 // Añadir marcador temporal para feedback visual
                const tempMarker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(`<b>Posición seleccionada</b><br>Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}<br><button onclick="fillStopForm(${lat}, ${lng})">Usar estas coords.</button>`)
                    .openPopup();

                 // Opcional: eliminar marcador temporal después de un tiempo o al cerrar popup
                 tempMarker.on('popupclose', () => {
                     map.removeLayer(tempMarker);
                 });
            });
        }

         // Función llamada desde el popup del marcador temporal
        function fillStopForm(lat, lng) {
            stopLatInput.value = lat.toFixed(6);
            stopLngInput.value = lng.toFixed(6);
             // Opcional: cerrar todos los popups
            map.closePopup();
        }

        function loadAverageSpeed() {
            // Intenta cargar desde localStorage si se implementa
            // const savedSpeed = localStorage.getItem('smartMoveProAvgSpeed');
            // if (savedSpeed) {
            //     averageSpeedKMH = parseFloat(savedSpeed);
            //     avgSpeedInput.value = averageSpeedKMH;
            // } else {
                averageSpeedKMH = parseFloat(avgSpeedInput.value) || 30;
            // }
        }

        // --- Gestión de Paradas ---
        function addStop() {
            const name = stopNameInput.value.trim();
            const time = stopTimeInput.value;
            const lat = parseFloat(stopLatInput.value);
            const lng = parseFloat(stopLngInput.value);

            if (!name || !time || isNaN(lat) || isNaN(lng)) {
                alert("Por favor, completa todos los campos de la parada (nombre, hora, latitud y longitud válidas). Puedes hacer clic en el mapa para obtener coordenadas.");
                return;
            }

            const newStop = {
                id: Date.now(), // ID único simple
                name: name,
                time: time, // Formato HH:MM
                lat: lat,
                lng: lng
            };

            stops.push(newStop);
            renderStopsList();
            addStopMarker(newStop);

            // Limpiar formulario
            stopNameInput.value = '';
            stopTimeInput.value = '';
            stopLatInput.value = '';
            stopLngInput.value = '';

            startRouteBtn.disabled = false; // Habilitar botón de inicio
        }

         function removeStop(stopId) {
             // Eliminar de la lista
             stops = stops.filter(stop => stop.id !== stopId);

             // Eliminar marcador del mapa
             if (stopMarkers[stopId]) {
                 map.removeLayer(stopMarkers[stopId]);
                 delete stopMarkers[stopId];
             }

             renderStopsList();

             if (stops.length === 0) {
                 startRouteBtn.disabled = true;
                 stopTracking(); // Detener seguimiento si no quedan paradas
                 updateStatusDisplay("idle", "Añade paradas para iniciar.");
             } else if (currentStopIndex >= stops.length) {
                 // Si se eliminó la última parada activa o una posterior
                 currentStopIndex = stops.length -1; // Ajustar índice si es necesario (o detener)
                  if (currentStopIndex < 0) stopTracking(); // Detener si ya no hay paradas
             }
             // Si se elimina una parada anterior a la actual, el índice no necesita cambiar
             // Si se elimina la parada actual, avanzará a la siguiente en la próxima actualización
         }

        function renderStopsList() {
            stopsList.innerHTML = ''; // Limpiar lista actual
             stops.sort((a, b) => a.time.localeCompare(b.time)); // Ordenar por hora

            stops.forEach((stop, index) => {
                const li = document.createElement('li');
                 li.innerHTML = `
                    <span>${index + 1}. ${stop.name} (${stop.time})</span>
                    <button onclick="removeStop(${stop.id})">X</button>
                `;
                stopsList.appendChild(li);
            });
        }

        function addStopMarker(stop) {
             const marker = L.marker([stop.lat, stop.lng]).addTo(map)
                .bindPopup(`<b>${stop.name}</b><br>Programado: ${stop.time}`);
             stopMarkers[stop.id] = marker;
        }

        // --- Seguimiento de Ruta y GPS ---
        function startRouteTracking() {
            if (stops.length === 0) {
                alert("Añade al menos una parada a la ruta.");
                return;
            }
            if (watchId) {
                 // Si ya está corriendo, no hacer nada o quizás reiniciar?
                 console.log("El seguimiento ya está activo.");
                 return;
             }

            currentStopIndex = 0; // Empezar con la primera parada
             renderStopsList(); // Re-renderizar para posible resaltado futuro
            updateStatusDisplay("idle", "Iniciando seguimiento...");
            startRouteBtn.textContent = "Seguimiento Activo";
             startRouteBtn.disabled = true; // Deshabilitar mientras corre


            // Iniciar watcher de GPS
            if (navigator.geolocation) {
                 const options = {
                     enableHighAccuracy: true, // Intentar obtener la máxima precisión
                     timeout: 20000,          // Tiempo máximo para obtener una posición (20 seg)
                     maximumAge: 5000         // Usar caché si tiene menos de 5 seg
                 };
                watchId = navigator.geolocation.watchPosition(
                    handleLocationUpdate,
                    handleLocationError,
                    options
                );
                updateGPSStatus("GPS activado, esperando señal...");
            } else {
                alert("Geolocalización no es soportada por este navegador.");
                updateStatusDisplay("idle", "Error: Geolocalización no soportada.");
                startRouteBtn.textContent = "Iniciar Seguimiento de Ruta";
                startRouteBtn.disabled = stops.length === 0;

            }
        }

         function stopTracking() {
             if (watchId) {
                 navigator.geolocation.clearWatch(watchId);
                 watchId = null;
             }
             currentStopIndex = -1;
             lastKnownPosition = null;
             if (currentLocationMarker) {
                 map.removeLayer(currentLocationMarker);
                 currentLocationMarker = null;
             }
             updateStatusDisplay("idle", "Seguimiento detenido.");
             updateGPSStatus("GPS desactivado.");
             startRouteBtn.textContent = "Iniciar Seguimiento de Ruta";
             startRouteBtn.disabled = stops.length === 0;
             console.log("Seguimiento detenido.");
         }


        function handleLocationUpdate(position) {
            lastKnownPosition = position; // Guardar la última posición
            const { latitude, longitude, accuracy } = position.coords;
             updateGPSStatus(`Activo | Precisión: ${accuracy.toFixed(0)}m`);

            // Actualizar marcador del chófer en el mapa
            if (!currentLocationMarker) {
                currentLocationMarker = L.circleMarker([latitude, longitude], {
                    radius: 8,
                    fillColor: "#007bff",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map)
                  .bindPopup("Tu ubicación actual").openPopup();
            } else {
                currentLocationMarker.setLatLng([latitude, longitude]);
            }
             // Centrar mapa en el usuario la primera vez o si opción está activa
            // map.setView([latitude, longitude]); // Descomentar si quieres que siempre centre

             // Si no hay ruta activa o se completó, no calcular nada más
            if (currentStopIndex < 0 || currentStopIndex >= stops.length) {
                updateStatusDisplay("idle", "Ruta completada o no iniciada.");
                 stopTracking(); // Detener si se completó
                return;
            }

            // --- Lógica Principal de Cálculo ---
             const nextStop = stops[currentStopIndex];

            // 1. Calcular distancia a la próxima parada
            const distanceKm = calculateDistance(latitude, longitude, nextStop.lat, nextStop.lng);

            // 2. Estimar tiempo de viaje (simplificado)
            const avgSpeedMPS = (averageSpeedKMH * 1000) / 3600; // km/h a m/s
            const distanceM = distanceKm * 1000;
             let estimatedTimeSeconds;
             if (avgSpeedMPS > 0) {
                 estimatedTimeSeconds = distanceM / avgSpeedMPS;
             } else {
                 estimatedTimeSeconds = Infinity; // Evitar división 
