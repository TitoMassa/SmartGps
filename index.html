<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <title>Smart Move Pro</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; background:black; color:white; font-family: sans-serif; }
    #map { height: 50%; width: 100%; }
    #controls { padding:10px; }
    .btn { background: #333; color:white; border:none; padding:8px 12px; margin:4px; border-radius:4px; }
    .btn:hover { background: #555; }
    .route-list { max-height: 100px; overflow-y: auto; border:1px solid #444; margin:4px 0; }
    .stop-time { font-size: 1.5em; margin-top:10px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <div>
      <button id="new-route" class="btn">Nueva Ruta</button>
      <select id="route-select" class="btn"></select>
      <button id="save-route" class="btn">Guardar Ruta</button>
      <button id="load-route" class="btn">Cargar Ruta</button>
    </div>
    <div>
      <button id="start-tracking" class="btn">Iniciar Seguimiento</button>
      <button id="stop-tracking" class="btn">Detener Seguimiento</button>
    </div>
    <div>
      <label><input type="checkbox" id="manual-switch"> Manual (prev/next)</label>
      <button id="prev-stop" class="btn">Anterior</button>
      <button id="next-stop" class="btn">Siguiente</button>
    </div>
    <div class="stop-time" id="time-diff">+00:00</div>
  </div>  <!-- Leaflet JS -->  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>  <script>
    // Variables
    let map = L.map('map').setView([-27.4806, -58.8349], 13); // Corrientes default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
    let routes = []; // Array of routes: each is array of stops
    let currentRoute = null;
    let currentStopIdx = 0;
    let tracking = false;
    let watchId = null;

    // Icons
    const stopIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [25,25] });
    const driverIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [30,30], iconAnchor:[15,15] });

    let driverMarker;
    let lines = [];

    // Add stop on map click
    map.on('click', e => {
      if (!currentRoute) return;
      let time = prompt('Horario llegada (HH:MM)');
      if (!time) return;
      let [h,m] = time.split(':').map(Number);
      let stop = { latlng: e.latlng, schedule: { h, m } };
      // Add marker
      stop.marker = L.marker(e.latlng, { icon: stopIcon }).addTo(map);
      currentRoute.push(stop);
      redrawRoute();
    });

    // Redraw polyline
    function redrawRoute() {
      lines.forEach(l=>map.removeLayer(l)); lines = [];
      if (!currentRoute) return;
      let latlngs = currentRoute.map(s=>s.latlng);
      let line = L.polyline(latlngs, { color: 'white' }).addTo(map);
      lines.push(line);
    }

    // UI handlers
    document.getElementById('new-route').onclick = ()=>{
      let name = prompt('Nombre de la ruta'); if(!name) return;
      routes.push({ name, stops: [] });
      currentRoute = routes[routes.length-1].stops;
      updateRouteSelect();
    };
    function updateRouteSelect() {
      let sel = document.getElementById('route-select'); sel.innerHTML='';
      routes.forEach((r,i)=>{
        let opt = document.createElement('option'); opt.value=i; opt.text=r.name; sel.add(opt);
      });
    }
    document.getElementById('route-select').onchange = e=>{
      clearMap(); currentRoute = routes[e.target.value].stops; currentStopIdx=0; redrawRoute();
    };
    document.getElementById('save-route').onclick = ()=>{
      localStorage.setItem('routes', JSON.stringify(routes)); alert('Rutas guardadas');
    };
    document.getElementById('load-route').onclick = ()=>{
      let data = localStorage.getItem('routes'); if(data){ routes=JSON.parse(data); updateRouteSelect(); alert('Rutas cargadas'); }
    };

    // Tracking
    document.getElementById('start-tracking').onclick = ()=>{
      if(tracking) return; tracking=true;
      watchId = navigator.geolocation.watchPosition(onPosition, err=>console.error(err), { enableHighAccuracy:true });
    };
    document.getElementById('stop-tracking').onclick = ()=>{
      if(watchId!==null) navigator.geolocation.clearWatch(watchId);
      tracking=false; document.getElementById('time-diff').textContent='+00:00';
    };

    function onPosition(pos) {
      let latlng = [pos.coords.latitude, pos.coords.longitude];
      if(driverMarker) map.removeLayer(driverMarker);
      driverMarker = L.marker(latlng, { icon: driverIcon }).addTo(map);
      if(!currentRoute || currentRoute.length===0) return;
      // automatic stop advance by proximity
      if(!document.getElementById('manual-switch').checked) {
        let nextStop = currentRoute[currentStopIdx];
        let dist = map.distance(latlng, nextStop.latlng);
        if(dist < 20 && currentStopIdx < currentRoute.length-1) {
          currentStopIdx++;
        }
      }
      updateTimeDiff(latlng);
    }

    // Manual next/prev
    document.getElementById('prev-stop').onclick = ()=>{ if(currentStopIdx>0) currentStopIdx--; updateTimeDiff(driverMarker.getLatLng()); };
    document.getElementById('next-stop').onclick = ()=>{ if(currentStopIdx<currentRoute.length-1) currentStopIdx++; updateTimeDiff(driverMarker.getLatLng()); };

    // Compute time difference
    function updateTimeDiff(latlng) {
      let stop = currentRoute[currentStopIdx];
      let now = new Date();
      let sched = new Date(now);
      sched.setHours(stop.schedule.h, stop.schedule.m, 0, 0);
      // If schedule earlier than now and more than 12h difference, assume next day
      if(sched - now < -12*3600*1000) sched.setDate(sched.getDate()+1);
      let dist = map.distance(latlng, stop.latlng);
      // Placeholder: treat 0 speed, ignore travel time
      let diffMs = sched - now;
      let sign = diffMs>=0? '+' : '-';
      diffMs = Math.abs(diffMs);
      let mm = String(Math.floor(diffMs/60000)).padStart(2,'0');
      let ss = String(Math.floor((diffMs%60000)/1000)).padStart(2,'0');
      document.getElementById('time-diff').textContent = `${sign}${mm}:${ss}`;
    }

    function clearMap() {
      // remove markers and lines
      map.eachLayer(layer=>{
        if(layer instanceof L.Marker) map.removeLayer(layer);
      }); lines.forEach(l=>map.removeLayer(l)); lines=[];
    }
  </script></body>
</html>
