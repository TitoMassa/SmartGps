<!DOCTYPE html>
<html>
<head>
    <title>Smart Move Pro</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: black;
            color: white;
        }
        #map {
            width: 100%;
            height: 400px;
        }
        .controls {
            padding: 10px;
        }
        .route-list {
            margin-top: 10px;
        }
        .route-item {
            margin-bottom: 5px;
        }
        .deviation-positive {
            color: green;
        }
        .deviation-negative {
            color: red;
        }
        input[type="text"], input[type="time"], select {
            background-color: #333;
            color: white;
            border: none;
            padding: 5px;
            margin-bottom: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #555;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            margin-top: 5px;
        }
        button:hover {
            background-color: #777;
        }
        label {
            display: block;
            margin-bottom: 3px;
        }

    </style>
</head>
<body>

    <div id="map"></div>

    <div class="controls">
        <h2>Smart Move Pro</h2>

        <h3>Crear Ruta</h3>

        <label for="routeName">Nombre de la Ruta:</label>
        <input type="text" id="routeName" placeholder="Nombre">

        <label for="calculateAutomatically">Calcular horarios automáticamente:</label>
        <input type="checkbox" id="calculateAutomatically">

        <button onclick="addStop('inicio')">Agregar Inicio</button>
        <button onclick="addStop('final')">Agregar Final</button>
        <button onclick="addStop('intermedia')">Agregar Parada Intermedia</button>
        <button onclick="saveRoute()">Guardar Ruta</button>
        <button onclick="clearRoute()">Limpiar Ruta</button>
        <h3>Rutas Guardadas</h3>
        <select id="savedRoutes" onchange="loadRoute()"></select>
        <button onclick="deleteRoute()">Eliminar Ruta</button>
        <button onclick="startTracking()">Iniciar Seguimiento</button>
        <button onclick="stopTracking()">Detener Seguimiento</button>

        <label for="manualAdvance">Avance Manual:</label>
        <input type="checkbox" id="manualAdvance">

        <button onclick="previousStop()">Parada Anterior</button>
        <button onclick="nextStop()">Parada Siguiente</button>
        <button onclick="addToQueue()">Agregar a Cola</button>

        <h3>Cola de Rutas</h3>
        <ul id="routeQueue"></ul>

        <h3>Información de Seguimiento</h3>
        <p>Velocidad: <span id="speed">0</span> km/h</p>
        <p>Desvío Horario: <span id="deviation" class="deviation-neutral">00:00</span></p>
        <p>Próxima Parada: <span id="nextStopName">Ninguna</span></p>
    </div>

    <script>

        var map = L.map('map').setView([-34.6037, -58.3816], 13); // Buenos Aires
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var route = [];
        var routeLayer = L.layerGroup().addTo(map);
        var currentPositionMarker;
        var currentRouteIndex = 0;
        var watchID;
        var routeQueue = []; //Cola de rutas

        // Funciones de Almacenamiento en Cache
        function saveRoute() {
            let routeName = document.getElementById("routeName").value;
            if (!routeName) {
                alert("Debe ingresar un nombre para la ruta.");
                return;
            }
            if (route.length < 2) {
                alert("Debe tener al menos una parada de inicio y final.");
                return;
            }
            localStorage.setItem("route_" + routeName, JSON.stringify(route));
            loadSavedRoutes();
            alert("Ruta guardada.");
        }

        function loadRoute() {
            let routeName = document.getElementById("savedRoutes").value;
            if (routeName) {
                route = JSON.parse(localStorage.getItem("route_" + routeName));
                displayRoute();
                alert("Ruta cargada.");
            }
        }

        function deleteRoute() {
            let routeName = document.getElementById("savedRoutes").value;
            if (routeName) {
                localStorage.removeItem("route_" + routeName);
                loadSavedRoutes();
                clearRoute();
                alert("Ruta eliminada.");
            }
        }

        function loadSavedRoutes() {
            let select = document.getElementById("savedRoutes");
            select.innerHTML = ""; // Limpiar opciones
            for (let i = 0; i < localStorage.length; i++) {
                let key = localStorage.key(i);
                if (key.startsWith("route_")) {
                    let routeName = key.substring(6);
                    let option = document.createElement("option");
                    option.value = routeName;
                    option.text = routeName;
                    select.add(option);
                }
            }
        }

        // Inicialización de Rutas Guardadas
        loadSavedRoutes();

        // Funciones de Ruta
        function addStop(type) {
            let stopName = prompt("Ingrese el nombre de la parada:");
            if (!stopName) return;

            let time = prompt("Ingrese el horario (HH:MM):");
            if (!time && (type === 'inicio' || type === 'final') ) {
                alert("El horario de inicio y fin es obligatorio.");
                return;
            }
            let autoCalculate = document.getElementById("calculateAutomatically").checked;

            map.on('click', function(e) {
                map.off('click'); // Desactiva el evento click después de la primera parada.

                let lat = e.latlng.lat;
                let lng = e.latlng.lng;

                let stop = {
                    name: stopName,
                    type: type,
                    lat: lat,
                    lng: lng,
                    time: time,
                };
                route.push(stop);
                displayRoute();
                alert("Parada " + type + " agregada.  Puede agregar más paradas");
            });
            alert("Toque en el mapa para definir la ubicación de la parada.");
        }

        function clearRoute() {
            route = [];
            displayRoute();
        }

        function displayRoute() {
            routeLayer.clearLayers();
            if (route.length === 0) return;
            let startIcon = L.divIcon({className: 'start-icon', html: '<div style="background-color: #' + Math.floor(Math.random()*16777215).toString(16) + '; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; font-weight: bold;">I</div>'});
            let endIcon = L.divIcon({className: 'end-icon', html: '<div style="background-color: #' + Math.floor(Math.random()*16777215).toString(16) + '; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; font-weight: bold;">F</div>'});

            for (let i = 0; i < route.length; i++) {
                let stop = route[i];
                let marker;
                if (stop.type === 'inicio') {
                    marker = L.marker([stop.lat, stop.lng], {icon: startIcon}).addTo(routeLayer).bindPopup(stop.name + "<br>Horario: " + stop.time);
                } else if (stop.type === 'final') {
                    marker = L.marker([stop.lat, stop.lng], {icon: endIcon}).addTo(routeLayer).bindPopup(stop.name + "<br>Horario: " + stop.time);
                } else {
                    let intermediateIcon = L.divIcon({className: 'intermediate-icon', html: '<div style="background-color: #' + Math.floor(Math.random()*16777215).toString(16) + '; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; font-weight: bold;">' + (i) + '</div>'});
                    marker = L.marker([stop.lat, stop.lng], {icon: intermediateIcon}).addTo(routeLayer).bindPopup(stop.name + "<br>Horario: " + (stop.time ? stop.time : "Sin horario"));
                }
                //marker.bindPopup(stop.name + "<br>Tipo: " + stop.type + "<br>Horario: " + stop.time);
            }

            // Dibujar línea
            let latlngs = route.map(stop => [stop.lat, stop.lng]);
            if (latlngs.length > 1) {
                L.polyline(latlngs, {color: 'red'}).addTo(routeLayer);
                map.fitBounds(L.polyline(latlngs, {color: 'red'}).getBounds());
            }
        }

        // Funciones de Seguimiento
        function startTracking() {
            if (route.length < 2) {
                alert("Debe cargar o crear una ruta con al menos una parada de inicio y final.");
                return;
            }
            currentRouteIndex = 0;
            if ("geolocation" in navigator) {
                watchID = navigator.geolocation.watchPosition(
                    updatePosition,
                    handleError,
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
                alert("Seguimiento iniciado.");
                updateNextStop();
            } else {
                alert("Geolocalización no soportada.");
            }
        }

        function stopTracking() {
            if (watchID) {
                navigator.geolocation.clearWatch(watchID);
                watchID = null;
                if(currentPositionMarker){
                    map.removeLayer(currentPositionMarker);
                }
                currentPositionMarker = null;
                document.getElementById("speed").innerText = "0";
                document.getElementById("deviation").innerText = "00:00";
                document.getElementById("deviation").className = "deviation-neutral";
                document.getElementById("nextStopName").innerText = "Ninguna";
                alert("Seguimiento detenido.");
            } else {
                alert("El seguimiento no ha sido iniciado.");
            }
        }

        function updatePosition(position) {
            let lat = position.coords.latitude;
            let lng = position.coords.longitude;
            let speed = position.coords.speed ? (position.coords.speed * 3.6).toFixed(2) : 0; // Convertir m/s a km/h

            document.getElementById("speed").innerText = speed;

            if (currentPositionMarker) {
                currentPositionMarker.setLatLng([lat, lng]);
            } else {
                currentPositionMarker = L.marker([lat, lng]).addTo(map).bindPopup("Tú estás aquí");
                map.setView([lat, lng], 16); // Centrar en la ubicación del usuario
            }

            calculateDeviation(lat, lng);

            //Detección Automática de Parada
            if(!document.getElementById("manualAdvance").checked){
                autoAdvance(lat, lng);
            }

        }

        function handleError(error) {
            alert("Error al obtener la ubicación: " + error.message);
        }

        function calculateDeviation(lat, lng) {
            if (route.length < 2 || currentRouteIndex >= route.length - 1) return;

            let pointA = route[currentRouteIndex];
            let pointB = route[currentRouteIndex + 1];

            let totalDistance = calculateDistance(pointA.lat, pointA.lng, pointB.lat, pointB.lng);
            let totalTime = timeDifference(pointA.time, pointB.time); // en minutos

            let currentDistance = calculateDistance(pointA.lat, pointA.lng, lat, lng);

            let positionPercentage = currentDistance / totalDistance;
            if (positionPercentage > 1) positionPercentage = 1; // No exceder 100%

            let expectedTimeMinutes = positionPercentage * totalTime; // Tiempo esperado en minutos

            let expectedArrivalTime = new Date();
            let startTimeParts = pointA.time.split(":");
            expectedArrivalTime.setHours(parseInt(startTimeParts[0]));
            expectedArrivalTime.setMinutes(parseInt(startTimeParts[1]));
            expectedArrivalTime.setSeconds(0);
            expectedArrivalTime.setMilliseconds(0);

            expectedArrivalTime.setMinutes(expectedArrivalTime.getMinutes() + expectedTimeMinutes);

            let now = new Date();
            let deviationMinutes = (now.getTime() - expectedArrivalTime.getTime()) / (60 * 1000);

            let deviationSign = deviationMinutes >= 0 ? "+" : "-";
            let absDeviationMinutes = Math.abs(Math.floor(deviationMinutes));
            let absDeviationSeconds = Math.abs(Math.floor((deviationMinutes - Math.floor(deviationMinutes)) * 60));

            let deviationString = deviationSign + pad(absDeviationMinutes) + ":" + pad(absDeviationSeconds);

            document.getElementById("deviation").innerText = deviationString;
            if (deviationMinutes >= 0) {
                document.getElementById("deviation").className = "deviation-positive";
            } else {
                document.getElementById("deviation").className = "deviation-negative";
            }
        }

        function timeDifference(startTime, endTime) {
            let startParts = startTime.split(":");
            let endParts = endTime.split(":");

            let startDate = new Date(0, 0, 0, parseInt(startParts[0]), parseInt(startParts[1]), 0);
            let endDate = new Date(0, 0, 0, parseInt(endParts[0]), parseInt(endParts[1]), 0);

            let diff = endDate.getTime() - startDate.getTime();
            let minutes = Math.abs(diff) / (1000 * 60);

            return minutes;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radio de la Tierra en km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distancia en km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180)
        }

        function pad(num) {
            return num < 10 ? "0" + num : num;
        }

        // Funcionalidad Avance Manual
        function nextStop() {
            if (currentRouteIndex < route.length - 1) {
                currentRouteIndex++;
                updateNextStop();
                alert("Avanzando a la siguiente parada.");
            } else {
                alert("Ya está en la última parada.");
            }
        }

        function previousStop() {
            if (currentRouteIndex > 0) {
                currentRouteIndex--;
                updateNextStop();
                alert("Retrocediendo a la parada anterior.");
            } else {
                alert("Ya está en la primera parada.");
            }
        }

        function updateNextStop() {
            if (route.length > 0 && currentRouteIndex < route.length - 1) {
                document.getElementById("nextStopName").innerText = route[currentRouteIndex + 1].name;
            } else if(currentRouteIndex >= route.length - 1) {
                document.getElementById("nextStopName").innerText = "Fin de la ruta";
            }else{
                document.getElementById("nextStopName").innerText = "Ninguna";
            }

        }

        function autoAdvance(lat, lng){
            if(route.length < 2) return;

            let pointA = route[currentRouteIndex];
            let pointB = route[currentRouteIndex + 1];

            let distanceToB = calculateDistance(lat, lng, pointB.lat, pointB.lng);
            let distanceToA = calculateDistance(lat, lng, pointA.lat, pointA.lng);

            if(distanceToB < 0.1 && currentRouteIndex < route.length -1){ //100 metros
                currentRouteIndex++;
                updateNextStop();
                alert("Avanzando a la siguiente parada automáticamente.");
            } else if (currentRouteIndex > 0 && distanceToA < 0.1){ //si ya pasó una parada, verifica la distancia a la anterior para ver si retrocede.
                let prevPoint = route[currentRouteIndex-1];
                let distanceToPrev = calculateDistance(lat, lng, prevPoint.lat, prevPoint.lng);
                if(distanceToPrev < 0.1){
                    currentRouteIndex--;
                    updateNextStop();
                    alert("Retrocediendo a la parada anterior automáticamente.");
                }
            }


            if(currentRouteIndex >= route.length - 1){
                alert("Ha llegado al final de la ruta.");
                stopTracking();
            }

        }

        // Funcionalidad Cola de Rutas
        function addToQueue() {
            let routeName = document.getElementById("routeName").value;
            if (!routeName) {
                alert("Debe ingresar un nombre para la ruta.");
                return;
            }
            routeQueue.push(routeName);
            updateRouteQueueDisplay();
            alert("Ruta agregada a la cola.");
        }

        function updateRouteQueueDisplay() {
            let queueList = document.getElementById("routeQueue");
            queueList.innerHTML = "";
            for (let i = 0; i < routeQueue.length; i++) {
                let routeName = routeQueue[i];
                let listItem = document.createElement("li");
                listItem.textContent = routeName;
                queueList.appendChild(listItem);
            }
        }

        //Inicio de la Cola
        function startQueue() {
          if (routeQueue.length === 0) {
            alert("La cola de rutas está vacía.");
            return;
          }

          // Obtiene la primera ruta de la cola
          let nextRouteName = routeQueue.shift();
          document.getElementById("savedRoutes").value = nextRouteName;

          // Carga la ruta y comienza el seguimiento
          loadRoute();
          startTracking();

          // Actualiza la visualización de la cola
          updateRouteQueueDisplay();
        }

    </script>

</body>
</html>
