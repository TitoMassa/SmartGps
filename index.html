<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000"/>
    <title>Smart Move Pro (PWA) - Refactorizado</title>
    
    <!-- Enlaces a Manifest y Estilos Externos -->
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="stylesheet" href="style.css">

    <!-- Script de Leaflet (se carga en el head) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</head>
<body>

    <div id="appContainer">
        <div id="map"></div>
        <div id="controls">
            
            <!-- Bot√≥n para mostrar/ocultar mapa en horizontal -->
            <button id="toggleMapBtn" onclick="toggleMapView()" class="btn-secondary" style="display: none;">Ver Mapa</button>

            <!-- Dashboard de seguimiento -->
            <div id="trackingDashboard" style="display: none;">
                <div>
                    <div id="trackingInfoDisplay">Ruta en Progreso</div>
                    <div id="timeDeviation">00:00</div>
                    <div id="trackingDetails">
                        <span id="speedDisplay">Velocidad: 0 KM/H</span>
                        <span id="nextStopDisplay">Pr√≥xima: N/A</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <button id="stopTrackingBtn" onclick="stopTracking()" class="btn-danger btn-block">Detener Seguimiento</button>
                        <div>
                          <input type="checkbox" id="manualStopNav" onchange="updateManualNavButtons()">
                          <label for="manualStopNav" style="display:inline;">Navegaci√≥n Manual</label>
                          <button id="prevStopBtn" onclick="goToPreviousActivePoint()" class="btn-secondary btn-sm" style="display:none;">Anterior</button>
                          <button id="nextStopBtn" onclick="goToNextActivePoint()" class="btn-secondary btn-sm" style="display:none;">Siguiente</button>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de paradas y ETAs durante el seguimiento -->
                <div id="trackingStopsListContainer">
                    <h4>Pr√≥ximas Paradas y ETA</h4>
                    <div id="trackingStopsList">
                        <!-- El contenido se generar√° con JavaScript -->
                    </div>
                </div>

                <!-- Bot√≥n y panel de Debug ETA -->
                <button id="toggleEtaDebugBtn" onclick="toggleEtaDebug()" class="btn-info btn-sm btn-block" style="margin-top: 15px;">üêõ Debug ETA</button>
                <div id="etaDebugPanel" style="display: none;">
                    <!-- El contenido de debug se generar√° con JavaScript -->
                </div>
            </div>

            <!-- Controles principales (acordeones) -->
            <div id="mainControlsContainer">
                <!-- SECCI√ìN 1: Edici√≥n de Ruta -->
                <div class="accordion-header active">1. Editar Ruta Actual</div>
                <div class="accordion-content active">
                    <p style="font-size: 0.85em; margin-top: 0; color: #8b949e;">
                        Toca una zona vac√≠a del mapa para a√±adir un punto. <br>
                        Toca un punto existente para editarlo o arr√°stralo para moverlo.
                    </p>
                    <button class="btn-info" onclick="toggleWaypointVisibility()">üëÅÔ∏è Ver/Ocultar Ptos. de Paso</button>
                    <button class="btn-danger" onclick="clearCurrentRoute()">üóëÔ∏è Limpiar Ruta Actual</button>
                    <hr style="border-color: #30363d; margin: 15px 0;">
                    
                    <h3>Lista de Puntos de Ruta</h3>
                    <input type="checkbox" id="autoCalcTimes" checked onchange="calculateAndApplyAllIntermediateTimes()">
                    <label for="autoCalcTimes" style="display:inline;">Calcular horarios intermedios autom√°ticamente</label>
                    <div id="stopsList" style="margin-top: 10px;">No hay puntos definidos.</div>
                </div>

                <!-- SECCI√ìN 2: Guardar y Cargar -->
                <div class="accordion-header">2. Guardar y Cargar Rutas</div>
                <div class="accordion-content">
                    <label for="routeName">Nombre de la Ruta:</label>
                    <input type="text" id="routeName" placeholder="Ej: Ruta Centro">
                    <button onclick="saveRoute()" class="btn-primary">üíæ Guardar Ruta</button>
                    <hr style="border-color: #30363d; margin: 20px 0;">
                    <label for="savedRoutes">Cargar Ruta Guardada:</label>
                    <select id="savedRoutes"></select>
                    <button onclick="loadRoute()" class="btn-secondary">Cargar</button>
                    <button onclick="deleteRoute()" class="btn-danger">Borrar</button>
                </div>

                <!-- SECCI√ìN 3: Seguimiento y Cola -->
                <div class="accordion-header">3. Iniciar Seguimiento y Cola</div>
                <div class="accordion-content">
                    <h3>Iniciar Seguimiento</h3>
                    <p style="font-size: 0.85em; color: #8b949e;">Aseg√∫rate de que la ruta actual tiene P. Inicio y P. Final con horarios definidos.</p>
                    <button id="startTrackingBtn" onclick="startTracking()" class="btn-primary btn-block">‚ñ∂Ô∏è Iniciar Seguimiento</button>
                    <hr style="border-color: #30363d; margin: 20px 0;">
                    
                    <h3>Cola de Rutas</h3>
                    <label for="routeToQueue">A√±adir ruta a la cola:</label>
                    <select id="routeToQueue"></select>
                    <button onclick="addRouteToQueue()" class="btn-info">A√±adir a Cola</button>
                    <h4>En Cola:</h4>
                    <div id="routeQueueDisplay">Vac√≠a.</div>
                    <button onclick="clearRouteQueue()" class="btn-danger">Limpiar Cola</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Script principal de la aplicaci√≥n (se carga al final para mejor rendimiento) -->
    <script src="script.js" defer></script>
</body>
</html>
