<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Move Pro</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f5f5f5;
    }
    #map {
      width: 100%;
      height: 40vh;
    }
    .controls {
      width: 95%;
      max-width: 480px;
      background: #fff;
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-top: -2rem;
      z-index: 1000;
    }
    .controls h2 {
      margin: 0 0 0.5rem;
      font-size: 1.25rem;
    }
    .controls label {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    .controls input, .controls button, .controls select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      font-size: 1rem;
    }
    .controls table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
    }
    .controls th, .controls td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      font-size: 0.85rem;
      text-align: center;
    }
    .controls .status {
      font-size: 1.5rem;
      text-align: center;
      margin-top: 0.5rem;
    }
    .btn-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .btn-group button { flex: 1; }
  </style>
</head>
<body>  <div id="map"></div>  <div class="controls">
    <h2>Smart Move Pro</h2>
    <label>Ruta:</label>
    <select id="route-select"></select>
    <div class="btn-group">
      <button id="new-route-btn">Nueva Ruta</button>
      <button id="save-route-btn">Guardar Ruta</button>
      <button id="delete-route-btn">Borrar Ruta</button>
    </div><label>Nombre de ruta nueva:</label>
<input type="text" id="new-route-name" placeholder="Nombre...">

<hr>
<h3>Paradas</h3>
<label>Latitud, Longitud:</label>
<input type="text" id="stop-latlng" placeholder="-34.6037, -58.3816">
<label>Hora llegada (HH:MM):</label>
<input type="time" id="stop-arrival">
<label>Hora salida (HH:MM):</label>
<input type="time" id="stop-departure">
<button id="add-stop-btn">Añadir Parada</button>

<table>
  <thead>
    <tr><th>#</th><th>Lat,Lng</th><th>Llegada</th><th>Salida</th><th>Acción</th></tr>
  </thead>
  <tbody id="stops-table"></tbody>
</table>

<div class="btn-group">
  <button id="start-btn">Iniciar Seguimiento</button>
  <button id="stop-btn" disabled>Detener Seguimiento</button>
</div>
<div class="btn-group">
  <button id="prev-stop-btn" disabled>Anterior</button>
  <button id="next-stop-btn" disabled>Siguiente</button>
</div>
<label><input type="checkbox" id="auto-advance" checked> Avance Automático</label>
<div class="status" id="time-diff">+00:00</div>

  </div>  <!-- Leaflet JS -->  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>  <script>
    // -- Variables globales --
    let map, markerCurrent;
    let routes = {};           // { name: [ stops ] }
    let routeOrder = [];
    let currentRoute = null;
    let currentStopIndex = 0;
    let watcherId = null;
    let updateInterval = null;
    const avgSpeedMps = 10;    // m/s por defecto (ajustable)

    // -- Inicialización de mapa --
    function initMap() {
      map = L.map('map').setView([-34.6037, -58.3816], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      markerCurrent = L.marker([0,0]).addTo(map);
    }

    // -- Cargar rutas de localStorage --
    function loadRoutes() {
      const data = localStorage.getItem('sm_routes');
      if(data) {
        const parsed = JSON.parse(data);
        routes = parsed.routes||{};
        routeOrder = parsed.order||[];
      }
      refreshRouteSelect();
    }
    function saveRoutes() {
      localStorage.setItem('sm_routes', JSON.stringify({ routes, order: routeOrder }));
      refreshRouteSelect();
    }
    function refreshRouteSelect() {
      const sel = document.getElementById('route-select');
      sel.innerHTML = '';
      routeOrder.forEach(name => {
        const opt = document.createElement('option'); opt.value = name; opt.text = name;
        sel.appendChild(opt);
      });
      sel.value = currentRoute;
      sel.onchange();
    }

    // -- Creación, borrado y selección de rutas --
    document.getElementById('new-route-btn').onclick = ()=>{
      const name = document.getElementById('new-route-name').value.trim();
      if(name && !routes[name]){
        routes[name]=[]; routeOrder.push(name);
        currentRoute=name; currentStopIndex=0; renderStops(); saveRoutes();
      }
    };
    document.getElementById('delete-route-btn').onclick = ()=>{
      if(currentRoute){ delete routes[currentRoute]; routeOrder = routeOrder.filter(n=>n!==currentRoute);
        currentRoute = routeOrder[0]||null; currentStopIndex=0; renderStops(); saveRoutes(); }
    };
    document.getElementById('route-select').onchange = ()=>{
      currentRoute = document.getElementById('route-select').value;
      currentStopIndex = 0;
      renderStops();
    };

    // -- Gestión de paradas --
    document.getElementById('add-stop-btn').onclick = ()=>{
      if(!currentRoute) return alert('Crear o seleccionar ruta primero');
      const ll = document.getElementById('stop-latlng').value.split(',').map(s=>parseFloat(s));
      const arr = document.getElementById('stop-arrival').value;
      const dep = document.getElementById('stop-departure').value;
      routes[currentRoute].push({ lat: ll[0], lng: ll[1], arrival: arr, departure: dep });
      renderStops(); saveRoutes();
    };
    function renderStops(){
      const tbody = document.getElementById('stops-table'); tbody.innerHTML='';
      if(!currentRoute) return;
      routes[currentRoute].forEach((stop,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${stop.lat.toFixed(5)}, ${stop.lng.toFixed(5)}</td>
          <td>${stop.arrival}</td><td>${stop.departure}</td>
          <td><button data-i="${i}" class="del-stop">X</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('.del-stop').forEach(btn=>{
        btn.onclick = ()=>{
          routes[currentRoute].splice(parseInt(btn.dataset.i),1);
          renderStops(); saveRoutes();
        };
      });
    }

    // -- Tracking GPS y cálculo de diferencia --
    function startTracking() {
      if(!currentRoute||routes[currentRoute].length===0) return alert('Agregar paradas primero');
      document.getElementById('start-btn').disabled=true;
      document.getElementById('stop-btn').disabled=false;
      document.getElementById('prev-stop-btn').disabled=false;
      document.getElementById('next-stop-btn').disabled=false;
      watcherId = navigator.geolocation.watchPosition(onLocation, console.error, { enableHighAccuracy: true });
      updateInterval = setInterval(updateTimeDiff, 1000);
    }
    function stopTracking(){
      navigator.geolocation.clearWatch(watcherId);
      clearInterval(updateInterval);
      document.getElementById('start-btn').disabled=false;
      document.getElementById('stop-btn').disabled=true;
    }
    document.getElementById('start-btn').onclick = startTracking;
    document.getElementById('stop-btn').onclick = stopTracking;
    document.getElementById('next-stop-btn').onclick = ()=>{ currentStopIndex = Math.min(currentStopIndex+1, routes[currentRoute].length-1); };
    document.getElementById('prev-stop-btn').onclick = ()=>{ currentStopIndex = Math.max(currentStopIndex-1,0); };

    let currPos = null;
    function onLocation(pos){
      currPos = [pos.coords.latitude, pos.coords.longitude];
      markerCurrent.setLatLng(currPos);
      map.setView(currPos);
    }
    function updateTimeDiff(){
      if(!currPos) return;
      const stops = routes[currentRoute]; if(!stops || !stops.length) return;
      if(currentStopIndex>=stops.length){ advanceRoute(); return; }
      const stop = stops[currentStopIndex];
      const dist = map.distance(currPos, [stop.lat, stop.lng]);
      const now = new Date();
      // Hora programada llegada parse
      const [h,m] = stop.arrival.split(':').map(Number);
      const scheduled = new Date(now);
      scheduled.setHours(h, m, 0, 0);
      // Estimado de viaje
      const travelSec = dist / avgSpeedMps;
      let diffSec = (scheduled - now)/1000 - travelSec;
      const sign = diffSec>=0? '+': '-';
      diffSec = Math.abs(Math.round(diffSec));
      const mm = String(Math.floor(diffSec/60)).padStart(2,'0');
      const ss = String(diffSec%60).padStart(2,'0');
      document.getElementById('time-diff').textContent = `${sign}${mm}:${ss}`;
      // Avance automático al llegar cerca y auto-advance
      if(document.getElementById('auto-advance').checked && dist<15){ // 15m radio
        currentStopIndex++;
      }
    }

    // -- Avanzar a siguiente ruta --
    function advanceRoute(){
      const idx = routeOrder.indexOf(currentRoute);
      if(idx < routeOrder.length-1){
        currentRoute = routeOrder[idx+1];
        currentStopIndex = 0;
        renderStops();
      } else {
        // fin de todas
        stopTracking();
      }
    }

    // -- Eventos guardar y cargar rutas --
    document.getElementById('save-route-btn').onclick = saveRoutes;

    // -- Inicio --
    window.onload = ()=>{
      initMap(); loadRoutes();
    };
  </script></body>
</html>
